<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.12.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: Implicit model</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeInteractiveToc.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorials-models-implicit-model.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Implicit model</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md95">Problem description</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md96">Defining the system of equations</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md97">Solving the system of equations</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md98">Remarks on the implicit function theorem</a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_content_2tutorials_2models_2implicit__model_2main"></a></p>
<h1><a class="anchor" id="autotoc_md95"></a>
Problem description</h1>
<p>One of the most notable differences between constitutive models and feed-forward neural networks is that updating certain stiff systems with implicit methods is often more computationally efficient compared to explicit algorithms.</p>
<p>A generally nonlinear, recursive, implicit system of equations take the following form    </p><p class="formulaDsp">
\begin{align*}
  \mathbf{r}(\tilde{\mathbf{s}}) &amp; = f(\tilde{\mathbf{s}}, \mathbf{f}, \mathbf{s}_n, \mathbf{f}_n; \mathbf{p}), \\
  \mathbf{s} &amp;= \mathop{\mathrm{root}}\limits_{\tilde{\mathbf{s}}} (\mathbf{r}).
\end{align*}
</p>
<p> Here \( \mathbf{r} \) represents the residual (for root-fiding) of the system of equations, and \( \mathbf{s} \), \( \mathbf{f} \), \( \mathbf{s}_n \), \( \mathbf{f}_n \) are defined by four reserved sub-axes in NEML2:</p><ul>
<li>The <code>state</code> sub-axis hosts input variables in set \( \tilde{\mathbf{s}} \). The variables on this sub-axis are the primary unknowns to be solved for. After solving the system, the <code>state</code> sub-axis hosts output variables in set \( \mathbf{s} \).</li>
<li>The <code>forces</code> sub-axis hosts <em>prescribed</em> input variables in set \( \mathbf{f} \). These variables are prescribed and, by definition, do not change while the system is being solved.</li>
<li>The <code>old_state</code> and <code>old_forces</code> sub-axes respectively correspond to \( \mathbf{s}_n \) and \( \mathbf{f}_n \). These variables correspond to the <em>previous</em> solution to the system to facilitate the recursive definition of internal variables in history-dependent models. The equivalent plastic strain in plasticity models is a well-known example.</li>
</ul>
<p>The Perzyna viscoplasticity model mentioned in a <a class="el" href="tutorials-models-model-composition.html">previous tutorial</a> takes this form:         </p><p class="formulaDsp">
\begin{align}
  \boldsymbol{\varepsilon}^e &amp; = \boldsymbol{\varepsilon} - \boldsymbol{\varepsilon}^p, \label{1} \\
  \boldsymbol{\sigma} &amp; = 3K\operatorname{vol}\boldsymbol{\varepsilon}^e + 2G\operatorname{dev}\boldsymbol{\varepsilon}^e, \label{2} \\
  \bar{\sigma} &amp; = J_2(\boldsymbol{\sigma}), \label{3} \\
  f^p &amp; = \bar{\sigma} - \sigma_y, \label{4} \\
  \boldsymbol{N} &amp; = \pdv{f^p}{\boldsymbol{\sigma}}, \label{5} \\
  \dot{\gamma} &amp; = \left( \dfrac{\left&lt; f^p \right&gt;}{\eta} \right)^n, \label{6} \\
  \dot{\boldsymbol{\varepsilon}}^p &amp; = \dot{\gamma} \boldsymbol{N}. \label{7}
\end{align}
</p>
<p> Its residual can be defined using backward-Euler time integration as   </p><p class="formulaDsp">
\begin{align}
  \mathbf{r}\left( \boldsymbol{\varepsilon}^p \right) = \boldsymbol{\varepsilon}^p - \boldsymbol{\varepsilon}^p_n - \left( t - t_n \right) \dot{\boldsymbol{\varepsilon}}^p, \label{8}
\end{align}
</p>
<p> the solution procedure of which is often referred to as the <em>return-mapping algorithm</em> in the solid mechanics community.</p>
<p>This tutorial illustrates the use of <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> in conjunction with a Newton-Raphson solver to perform the implicit update.</p>
<h1><a class="anchor" id="autotoc_md96"></a>
Defining the system of equations</h1>
<p>After searching among existing models provided by NEML2, we are able to translate each of these equations into a NEML2 model. The input file looks like</p>
<div class="fragment"><div class="line">[Models]</div>
<div class="line">  [eq1]</div>
<div class="line">    type = SR2LinearCombination</div>
<div class="line">    from_var = &#39;forces/E state/Ep&#39;</div>
<div class="line">    to_var = &#39;state/Ee&#39;</div>
<div class="line">    coefficients = &#39;1 -1&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq2]</div>
<div class="line">    type = LinearIsotropicElasticity</div>
<div class="line">    coefficients = &#39;1e5 0.3&#39;</div>
<div class="line">    coefficient_types = &#39;YOUNGS_MODULUS POISSONS_RATIO&#39;</div>
<div class="line">    strain = &#39;state/Ee&#39;</div>
<div class="line">    stress = &#39;state/S&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq3]</div>
<div class="line">    type = SR2Invariant</div>
<div class="line">    invariant_type = &#39;VONMISES&#39;</div>
<div class="line">    tensor = &#39;state/S&#39;</div>
<div class="line">    invariant = &#39;state/s&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq4]</div>
<div class="line">    type = YieldFunction</div>
<div class="line">    yield_stress = 5</div>
<div class="line">    yield_function = &#39;state/fp&#39;</div>
<div class="line">    effective_stress = &#39;state/s&#39;</div>
<div class="line">  []</div>
<div class="line">  [surface]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = &#39;eq3 eq4&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq5]</div>
<div class="line">    type = Normality</div>
<div class="line">    model = &#39;surface&#39;</div>
<div class="line">    function = &#39;state/fp&#39;</div>
<div class="line">    from = &#39;state/S&#39;</div>
<div class="line">    to = &#39;state/N&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq6]</div>
<div class="line">    type = PerzynaPlasticFlowRate</div>
<div class="line">    reference_stress = 100</div>
<div class="line">    exponent = 2</div>
<div class="line">    yield_function = &#39;state/fp&#39;</div>
<div class="line">    flow_rate = &#39;state/gamma_rate&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq7]</div>
<div class="line">    type = AssociativePlasticFlow</div>
<div class="line">    flow_rate = &#39;state/gamma_rate&#39;</div>
<div class="line">    flow_direction = &#39;state/N&#39;</div>
<div class="line">    plastic_strain_rate = &#39;state/Ep_rate&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq8]</div>
<div class="line">    type = SR2BackwardEulerTimeIntegration</div>
<div class="line">    variable = &#39;state/Ep&#39;</div>
<div class="line">  []</div>
<div class="line">  [system]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = &#39;eq1 eq2 surface eq5 eq6 eq7 eq8&#39;</div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p>Note the one-to-one correspondance between the models and the equations.</p>
<p>The structure of the system of equations can be summarized using the code below.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/neml2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  set_default_dtype(kFloat64);</div>
<div class="line">  <span class="keyword">auto</span> system = load_model(<span class="stringliteral">&quot;input1.i&quot;</span>, <span class="stringliteral">&quot;system&quot;</span>);</div>
<div class="line">  std::cout &lt;&lt; *system &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> DiagnosticsInterface.cxx:30</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">Name:       system</div>
<div class="line">Input:      forces/E [SR2]</div>
<div class="line">            forces/t [Scalar]</div>
<div class="line">            old_forces/t [Scalar]</div>
<div class="line">            old_state/Ep [SR2]</div>
<div class="line">            state/Ep [SR2]</div>
<div class="line">Output:     residual/Ep [SR2]</div>
<div class="line">Parameters: eq2_E [Scalar][Double][cpu]</div>
<div class="line">            eq2_nu [Scalar][Double][cpu]</div>
<div class="line">            eq4_sy [Scalar][Double][cpu]</div>
<div class="line">            eq6_eta [Scalar][Double][cpu]</div>
<div class="line">            eq6_n [Scalar][Double][cpu]</div>
<div class="line">Buffers:    eq1_c_0 [Scalar][Double][cpu]</div>
<div class="line">            eq1_c_1 [Scalar][Double][cpu]</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">import</span> torch</div>
<div class="line"> </div>
<div class="line">torch.set_default_dtype(torch.double)</div>
<div class="line">system = <a class="code hl_function" href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2.load_model</a>(<span class="stringliteral">&quot;input1.i&quot;</span>, <span class="stringliteral">&quot;system&quot;</span>)</div>
<div class="line">print(system)</div>
<div class="ttc" id="anamespaceneml2_html_aa98735f2ffd7c3ae8b0b339621eb8ab3"><div class="ttname"><a href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2::load_model</a></div><div class="ttdeci">std::shared_ptr&lt; Model &gt; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> neml2.cxx:51</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">Name:       system</div>
<div class="line">Input:      forces/E [SR2]</div>
<div class="line">            forces/t [Scalar]</div>
<div class="line">            old_forces/t [Scalar]</div>
<div class="line">            old_state/Ep [SR2]</div>
<div class="line">            state/Ep [SR2]</div>
<div class="line">Output:     residual/Ep [SR2]</div>
<div class="line">Parameters: eq2_E [Scalar][Double][cpu]</div>
<div class="line">            eq2_nu [Scalar][Double][cpu]</div>
<div class="line">            eq4_sy [Scalar][Double][cpu]</div>
<div class="line">            eq6_eta [Scalar][Double][cpu]</div>
<div class="line">            eq6_n [Scalar][Double][cpu]</div>
<div class="line">Buffers:    eq1_c_0 [Scalar][Double][cpu]</div>
<div class="line">            eq1_c_1 [Scalar][Double][cpu]</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><h1><a class="anchor" id="autotoc_md97"></a>
Solving the system of equations</h1>
<p>Once the system of equations are properly defined, we can use the <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> to solve the system of equations. The <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> is responsible for the following:</p><ul>
<li>(Re)declare the solution to the system of equations as output variables.</li>
<li>Validate the shape of input variables and residual variables to make sure the system is square.</li>
<li>Assemble the residual vector and Jacobian matrix of the underlying linear system.</li>
<li>Invoke a <em>solver</em> to solve the system of equations.</li>
<li>Apply the implicit function theorem to calculate exact derivatives (up to machine precision).</li>
</ul>
<p>NEML2 offers three fully vectorized Newton solvers to be used in conjunction with <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a>:</p><ul>
<li><a class="el" href="syntax-solvers.html#newton">Newton</a>, the (vectorized) vanilla version of the Newton-Raphson algorithm which always takes the "full" step.</li>
<li><a class="el" href="syntax-solvers.html#newtonwithlinesearch">NewtonWithLineSearch</a>, similar to Newton but offers several commonly used (again fully vectorized) line search strategies.</li>
<li><a class="el" href="syntax-solvers.html#newtonwithtrustregion">NewtonWithTrustRegion</a>, the trust-region variant of the Newton-Raphson algorithm, where a scalar-valued, fully vectorized quadratic sub-problem is solved to identify the search direction in each update.</li>
</ul>
<p>In addition, the assembly routines as well as the application of the implicit function theorem are also implemented in a vectorized fashion.</p>
<p>The additional sections needed in the input file are </p><div class="fragment"><div class="line">[Models]</div>
<div class="line">  [model]</div>
<div class="line">    type = ImplicitUpdate</div>
<div class="line">    implicit_model = &#39;system&#39;</div>
<div class="line">    solver = &#39;newton&#39;</div>
<div class="line">  []</div>
<div class="line">[]</div>
<div class="line"> </div>
<div class="line">[Solvers]</div>
<div class="line">  [newton]</div>
<div class="line">    type = Newton</div>
<div class="line">    rel_tol = 1e-08</div>
<div class="line">    abs_tol = 1e-10</div>
<div class="line">    max_its = 50</div>
<div class="line">    verbose = true</div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p>The <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> model can then be invoked in the same way as regular models.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/neml2.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/Scalar.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/SR2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  set_default_dtype(kFloat64);</div>
<div class="line">  <span class="keyword">auto</span> model = load_model(<span class="stringliteral">&quot;input2.i&quot;</span>, <span class="stringliteral">&quot;model&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create input variables</span></div>
<div class="line">  <span class="comment">// Unspecified variables are assumed to be zero</span></div>
<div class="line">  <span class="keyword">auto</span> E = SR2::fill(0.01, 0.005, -0.001);</div>
<div class="line">  <span class="keyword">auto</span> t = Scalar::full(1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Solve the implicit model</span></div>
<div class="line">  <span class="keyword">auto</span> outputs = model-&gt;value({{<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;E&quot;</span>), E}, {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;t&quot;</span>), t}});</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get the solution</span></div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;\nPlastic strain:\n&quot;</span> &lt;&lt; outputs[<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;Ep&quot;</span>)] &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1LabeledAxisAccessor_html"><div class="ttname"><a href="classneml2_1_1LabeledAxisAccessor.html">neml2::LabeledAxisAccessor</a></div><div class="ttdoc">The accessor containing all the information needed to access an item in a LabeledAxis.</div><div class="ttdef"><b>Definition</b> LabeledAxisAccessor.h:56</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">ITERATION   0, |R| = 3.540990e+01, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   1, |R| = 8.850542e+00, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   2, |R| = 2.210703e+00, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   3, |R| = 5.507485e-01, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   4, |R| = 1.357799e-01, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   5, |R| = 3.211516e-02, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   6, |R| = 6.470185e-03, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   7, |R| = 7.366970e-04, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   8, |R| = 1.601343e-05, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   9, |R| = 8.269535e-09, |R0| = 3.540990e+01</div>
<div class="line"> </div>
<div class="line">Plastic strain:</div>
<div class="line">0.001 *</div>
<div class="line"> 5.2193</div>
<div class="line"> 0.3262</div>
<div class="line">-5.5455</div>
<div class="line"> 0.0000</div>
<div class="line"> 0.0000</div>
<div class="line"> 0.0000</div>
<div class="line">[ CPUDoubleType{6} ]</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line">from neml2.tensors import Scalar, SR2</div>
<div class="line">import torch</div>
<div class="line"> </div>
<div class="line">torch.set_default_dtype(torch.double)</div>
<div class="line">model = neml2.load_model(&quot;input2.i&quot;, <span class="stringliteral">&quot;model&quot;</span>)</div>
<div class="line"> </div>
<div class="line"># Create input variables</div>
<div class="line"># Unspecified variables are assumed to be zero</div>
<div class="line">E = <a class="code hl_class" href="classneml2_1_1SR2.html">SR2</a>.<a class="code hl_function" href="classneml2_1_1SR2.html#a5aebbcf65b0ef2bd309133eae276ceae">fill</a>(0.01, 0.005, -0.001)</div>
<div class="line">t = <a class="code hl_class" href="classneml2_1_1Scalar.html">Scalar</a>.<a class="code hl_function" href="classneml2_1_1PrimitiveTensor.html#a0eb4c776dfa03b8189246d2e8b0f7990">full</a>(1)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Solve the implicit model</span></div>
<div class="line">outputs = model.value({<span class="stringliteral">&quot;forces/E&quot;</span>: E, <span class="stringliteral">&quot;forces/t&quot;</span>: t})</div>
<div class="line"> </div>
<div class="line"># Get the solution</div>
<div class="line">print(<span class="stringliteral">&quot;\nPlastic strain:&quot;</span>)</div>
<div class="line">print(outputs[<span class="stringliteral">&quot;state/Ep&quot;</span>])</div>
<div class="ttc" id="aclassneml2_1_1PrimitiveTensor_html_a0eb4c776dfa03b8189246d2e8b0f7990"><div class="ttname"><a href="classneml2_1_1PrimitiveTensor.html#a0eb4c776dfa03b8189246d2e8b0f7990">neml2::PrimitiveTensor::full</a></div><div class="ttdeci">static Derived full(const CScalar &amp;init, const TensorOptions &amp;options=default_tensor_options())</div><div class="ttdef"><b>Definition</b> PrimitiveTensor.h:275</div></div>
<div class="ttc" id="aclassneml2_1_1SR2_html"><div class="ttname"><a href="classneml2_1_1SR2.html">neml2::SR2</a></div><div class="ttdoc">The symmetric second order tensor.</div><div class="ttdef"><b>Definition</b> SR2.h:46</div></div>
<div class="ttc" id="aclassneml2_1_1SR2_html_a5aebbcf65b0ef2bd309133eae276ceae"><div class="ttname"><a href="classneml2_1_1SR2.html#a5aebbcf65b0ef2bd309133eae276ceae">neml2::SR2::fill</a></div><div class="ttdeci">static SR2 fill(const CScalar &amp;a, const TensorOptions &amp;options=default_tensor_options())</div><div class="ttdoc">Fill the diagonals with a11 = a22 = a33 = a.</div><div class="ttdef"><b>Definition</b> SR2.cxx:48</div></div>
<div class="ttc" id="aclassneml2_1_1Scalar_html"><div class="ttname"><a href="classneml2_1_1Scalar.html">neml2::Scalar</a></div><div class="ttdoc">Scalar.</div><div class="ttdef"><b>Definition</b> Scalar.h:38</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">ITERATION   0, |R| = 3.540990e+01, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   1, |R| = 8.850542e+00, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   2, |R| = 2.210703e+00, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   3, |R| = 5.507485e-01, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   4, |R| = 1.357799e-01, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   5, |R| = 3.211516e-02, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   6, |R| = 6.470185e-03, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   7, |R| = 7.366970e-04, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   8, |R| = 1.601343e-05, |R0| = 3.540990e+01</div>
<div class="line">ITERATION   9, |R| = 8.269535e-09, |R0| = 3.540990e+01</div>
<div class="line"> </div>
<div class="line">Plastic strain:</div>
<div class="line">0.001 *</div>
<div class="line"> 5.2193</div>
<div class="line"> 0.3262</div>
<div class="line">-5.5455</div>
<div class="line"> 0.0000</div>
<div class="line"> 0.0000</div>
<div class="line"> 0.0000</div>
<div class="line">[ CPUDoubleType{6} ]</div>
<div class="line">&lt;Tensor of shape [][][6]&gt;</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><h1><a class="anchor" id="autotoc_md98"></a>
Remarks on the implicit function theorem</h1>
<p>Unlike other regular models, declaring variables on the <em>correct</em> sub-axes is important because NEML2 relies on the reserved sub-axes (<code>state</code>, <code>forces</code>, etc.)</p><ul>
<li>To determine whether the variable value and derivatives should be calculated during the assembly of residual and Jacobian. For example, the derivatives with respect to all variables on the <code>forces</code> sub-axis are skipped because they are not required in the assembly of the linear system.</li>
<li>To efficiently reuse the factorization of the system Jacobian when applying the implicit function theorem.</li>
</ul>
<p>As long as models are defined using the <em>correct</em> sub-axis definitions and satisfy some mild continuity requirements, <b>NEML2 guarantees the correctness of the variable derivatives</b> after one or more implicit updates, up to machine precision. The same guarantee also applies to user-defined custom models.</p>
<p>This is a significant advantage compared to some of the alternative constitutive model libraries, especially in the context of coupling with external PDE solvers. For example, in the context of finite element method, thermodynamic forces (e.g. strain) are calculated at each quadrature point, and the constitutive library (e.g. NEML2) is responsible for updating the thermodynamic state variables (e.g. stress, plastic strain, etc.), which are then used in the residual definition of the discretized PDE. Therefore, the exact derivatives of the state variables with respect to the forces are the key to the assembly of the exact Jacobian of the descretized PDE, which is in turn the fundamental requirement for optimal convergence for many nonlinear solvers.</p>
<div class="section_buttons"></div><div class="section_buttons"><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Previous   </th><th class="markdownTableHeadRight">Next    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="tutorials-models-model-parameters-revisited.html">Model parameters (revisited)</a>   </td><td class="markdownTableBodyRight"><a class="el" href="tutorials-models-transient-driver.html">Transient driver</a>   </td></tr>
</table>
</div><div class="section_buttons"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
