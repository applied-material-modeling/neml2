<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.13.2" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: Connection to input files</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorials-extension-connection-to-input-files.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Connection to input files</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md68">Parser</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md69">Input file</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md70">Registry</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md71">Factory</a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_content_2tutorials_2extension_2connection__to__input__files_2main"></a></p>
<p>NEML2 utilizes the well-established <a href="https://en.wikipedia.org/wiki/Factory_method_pattern">registry-factory pattern</a> to allow for runtime object creation and distributed class registration. In NEML2, <a class="el" href="classneml2_1_1Parser.html" title="A parser is responsible for parsing an input file into a collection of options which can be used by t...">neml2::Parser</a>, <a class="el" href="classneml2_1_1Registry.html">neml2::Registry</a>, and <a class="el" href="classneml2_1_1Factory.html">neml2::Factory</a> work together to create objects defined in the input file.</p>
<h1><a class="anchor" id="autotoc_md68"></a>
Parser</h1>
<p>A class is said to be runtime-manufacturable if its constructor can be retrieved at runtime using a string identification of its symbol. To allow for a unified object creation signature, runtime-manufacturable objects (e.g., models) are required to derive from <a class="el" href="classneml2_1_1NEML2Object.html" title="The base class of all &quot;manufacturable&quot; objects in the NEML2 library.">neml2::NEML2Object</a> and provide a constructor and a static method with the following signatures</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">class </span>ProjectileAcceleration : <span class="keyword">public</span> Model</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> OptionSet <a class="code hl_function" href="classneml2_1_1ProjectileAcceleration.html#acec712ff48d4c0884a1362c116f3257a">expected_options</a>();</div>
<div class="line">  <a class="code hl_function" href="classneml2_1_1ProjectileAcceleration.html#a83543b502da8255ced01db85b58bde37">ProjectileAcceleration</a>(<span class="keyword">const</span> OptionSet &amp; options);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="comment">// Model forward operator to be defined in the following tutorials</span></div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classneml2_1_1ProjectileAcceleration.html#ae6396730f8e20adc1c9d3875c473acdd">set_value</a>(<span class="keywordtype">bool</span>, <span class="keywordtype">bool</span>, <span class="keywordtype">bool</span>)<span class="keyword"> override </span>{}</div>
<div class="line">};</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1ProjectileAcceleration_html_a83543b502da8255ced01db85b58bde37"><div class="ttname"><a href="classneml2_1_1ProjectileAcceleration.html#a83543b502da8255ced01db85b58bde37">neml2::ProjectileAcceleration::ProjectileAcceleration</a></div><div class="ttdeci">ProjectileAcceleration(const OptionSet &amp;options)</div><div class="ttdef"><b>Definition</b> src1.cxx:46</div></div>
<div class="ttc" id="aclassneml2_1_1ProjectileAcceleration_html_acec712ff48d4c0884a1362c116f3257a"><div class="ttname"><a href="classneml2_1_1ProjectileAcceleration.html#acec712ff48d4c0884a1362c116f3257a">neml2::ProjectileAcceleration::expected_options</a></div><div class="ttdeci">static OptionSet expected_options()</div><div class="ttdef"><b>Definition</b> src1.cxx:34</div></div>
<div class="ttc" id="aclassneml2_1_1ProjectileAcceleration_html_ae6396730f8e20adc1c9d3875c473acdd"><div class="ttname"><a href="classneml2_1_1ProjectileAcceleration.html#ae6396730f8e20adc1c9d3875c473acdd">neml2::ProjectileAcceleration::set_value</a></div><div class="ttdeci">void set_value(bool, bool, bool) override</div><div class="ttdoc">The map between input -&gt; output, and optionally its derivatives.</div><div class="ttdef"><b>Definition</b> src1.cxx:13</div></div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> DiagnosticsInterface.cxx:30</div></div>
</div><!-- fragment --><ul>
<li>The static method <code>expected_options</code> allows the NEML2 registry to record required input options <em>expected</em> from the user in order to create an instance of the class.</li>
<li>The constructor is responsible for constructing an instance given input options <em>extracted</em> from the input file.</li>
<li>The parser is responsible for bridging the gap between the expected input options and the user-specified options.</li>
</ul>
<p>The following steps take place for each object during input file parsing:</p><ol type="1">
<li>Parser extracts object type from the reserved field <code>type</code>.</li>
<li>Parser retrieves <em>expected</em> input options from the registry.</li>
<li>Parser iterates over <em>user-specified</em> options and override default options.</li>
</ol>
<p>At the end of this process, a set of input options are gathered for the subsequent object creation.</p>
<p>All of the gathered options are stored in the NEML2 factory so that objects can be created at runtime per the user's request.</p>
<h1><a class="anchor" id="autotoc_md69"></a>
Input file</h1>
<p>Before defining the input file options for our custom model, it is a good idea to first design the syntax. For example, in this equation we are mapping from the projectile's current velocity to its acceleration, therefore we'd like to allow user to specify the variable names corresponding to the velocity and acceleration. In addition, since the equation is parametrized by the gravitational acceleration \(\boldsymbol{g}\) and the dynamic viscosity \(\nu\), we should allow user to set their values directly inside the input file (without modifying the source code).</p>
<p>Therefore, the input file syntax should look something like </p><div class="fragment"><div class="line">[Models]</div>
<div class="line">  [accel]</div>
<div class="line">    type = ProjectileAcceleration</div>
<div class="line">    velocity = &#39;state/v&#39;</div>
<div class="line">    acceleration = &#39;state/a&#39;</div>
<div class="line">    gravitational_acceleration = &#39;g&#39;</div>
<div class="line">    dynamic_viscosity = &#39;mu&#39;</div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p>By going through this exercise, we have effectively identified the <em>expected</em> input file options: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/tensors/Vec.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line">OptionSet</div>
<div class="line"><a class="code hl_function" href="classneml2_1_1ProjectileAcceleration.html#acec712ff48d4c0884a1362c116f3257a">ProjectileAcceleration::expected_options</a>()</div>
<div class="line">{</div>
<div class="line">  OptionSet options = <a class="code hl_function" href="classneml2_1_1Model.html#acec712ff48d4c0884a1362c116f3257a">Model::expected_options</a>();</div>
<div class="line">  options.set&lt;<a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>&gt;(<span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  options.set&lt;<a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>&gt;(<span class="stringliteral">&quot;acceleration&quot;</span>);</div>
<div class="line">  options.set&lt;TensorName&lt;Vec&gt;&gt;(<span class="stringliteral">&quot;gravitational_acceleration&quot;</span>);</div>
<div class="line">  options.set&lt;TensorName&lt;Scalar&gt;&gt;(<span class="stringliteral">&quot;dynamic_viscosity&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> options;</div>
<div class="line">}</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1Model_html_acec712ff48d4c0884a1362c116f3257a"><div class="ttname"><a href="classneml2_1_1Model.html#acec712ff48d4c0884a1362c116f3257a">neml2::Model::expected_options</a></div><div class="ttdeci">static OptionSet expected_options()</div><div class="ttdef"><b>Definition</b> Model.cxx:75</div></div>
<div class="ttc" id="anamespaceneml2_html_a9e1488821b46ffc106c90ab80036b7aa"><div class="ttname"><a href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">neml2::VariableName</a></div><div class="ttdeci">LabeledAxisAccessor VariableName</div><div class="ttdef"><b>Definition</b> LabeledAxisAccessor.h:185</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md70"></a>
Registry</h1>
<p>The registry is a <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII-style</a> singleton responsible for storing the mapping from the string identification of each runtime-manufacturable object to the constructor pointer along with the expected input file options.</p>
<p>The registration is accomplished by the static method <a class="el" href="classneml2_1_1Registry.html#adadcce9759678b439278443b8caea939" title="Add information on a NEML2Object to the registry.">neml2::Registry::add</a> templated on the class type. The static registration method combined with the singleton enables distributed class registration in each translation unit. The convenience macro register_NEML2_object and its variants wrap around <a class="el" href="classneml2_1_1Registry.html#adadcce9759678b439278443b8caea939" title="Add information on a NEML2Object to the registry.">neml2::Registry::add</a> to provide syntatic simplification of the registration call.</p>
<p>An example usage of the macro is </p><div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line">register_NEML2_object(ProjectileAcceleration);</div>
<div class="line">}</div>
</div><!-- fragment --><p> Note that a dummy static variable (unique to the class typename) is created to prevent duplicate registration.</p>
<h1><a class="anchor" id="autotoc_md71"></a>
Factory</h1>
<p>The NEML2 factory is another RAII-style singleton object which handles the runtime creation of objects. The generic API for object creation and retrieval is <a class="el" href="classneml2_1_1Factory.html#a95c47d292bea9037c83f2320ec3582db" title="Retrive an object pointer under the given section with the given object name.">neml2::Factory::get_object_ptr</a>.</p>
<p>In our example, the parser will first extract input file options from the input file and use them to fill out the expected options (defined by the <code>ProjectileAcceleration::expected_options()</code> method). The factory then pass the collected options to the constructor to create this object. The constructor should accept an <a class="el" href="classneml2_1_1OptionSet.html" title="A custom map-like data structure. The keys are strings, and the values can be nonhomogeneously typed.">neml2::OptionSet</a> and define how the collected options are used. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line"><a class="code hl_function" href="classneml2_1_1ProjectileAcceleration.html#a83543b502da8255ced01db85b58bde37">ProjectileAcceleration::ProjectileAcceleration</a>(<span class="keyword">const</span> OptionSet &amp; options)</div>
<div class="line">  : Model(options)</div>
<div class="line">    <span class="comment">// Variable and parameter declarations are to be added in the following tutorials</span></div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following tutorials will explain how to declare variables and parameters in the constructor.</p>
<p>Suppose an input file named "input.i" has the following content </p><div class="fragment"><div class="line">[Tensors]</div>
<div class="line">  [g]</div>
<div class="line">    type = Vec</div>
<div class="line">    values = &#39;0 -9.81 0&#39;</div>
<div class="line">  []</div>
<div class="line">  [mu]</div>
<div class="line">    type = Scalar</div>
<div class="line">    values = 0.001</div>
<div class="line">  []</div>
<div class="line">[]</div>
<div class="line"> </div>
<div class="line">[Models]</div>
<div class="line">  [accel]</div>
<div class="line">    type = ProjectileAcceleration</div>
<div class="line">    velocity = &#39;state/v&#39;</div>
<div class="line">    acceleration = &#39;state/a&#39;</div>
<div class="line">    gravitational_acceleration = &#39;g&#39;</div>
<div class="line">    dynamic_viscosity = &#39;mu&#39;</div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p> To verify that our custom model is correctly accepting these input file options, let us use the factory to create this model and examine the option values.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  <a class="code hl_function" href="namespaceneml2.html#a3c266b437e28eb7adec97c12b9a7e7d2">set_default_dtype</a>(<a class="code hl_variable" href="namespaceneml2.html#a16c96ec35672a72196d72131d3f5f8c3">kFloat64</a>);</div>
<div class="line">  <span class="keyword">auto</span> &amp; model = <a class="code hl_function" href="namespaceneml2.html#a1e499dee97d6a66663f60dd4a65b9f1a">neml2::load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;accel&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Print out each option parsed from the input file</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> &amp; options = model.input_options();</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;                  velocity: &quot;</span> &lt;&lt; options.get(<span class="stringliteral">&quot;velocity&quot;</span>) &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;              acceleration: &quot;</span> &lt;&lt; options.get(<span class="stringliteral">&quot;acceleration&quot;</span>) &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;gravitational_acceleration: &quot;</span> &lt;&lt; options.get(<span class="stringliteral">&quot;gravitational_acceleration&quot;</span>) &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;         dynamic_viscosity: &quot;</span> &lt;&lt; options.get(<span class="stringliteral">&quot;dynamic_viscosity&quot;</span>) &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceneml2_html_a16c96ec35672a72196d72131d3f5f8c3"><div class="ttname"><a href="namespaceneml2.html#a16c96ec35672a72196d72131d3f5f8c3">neml2::kFloat64</a></div><div class="ttdeci">constexpr auto kFloat64</div><div class="ttdef"><b>Definition</b> types.h:53</div></div>
<div class="ttc" id="anamespaceneml2_html_a1e499dee97d6a66663f60dd4a65b9f1a"><div class="ttname"><a href="namespaceneml2.html#a1e499dee97d6a66663f60dd4a65b9f1a">neml2::load_model</a></div><div class="ttdeci">Model &amp; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> Model.cxx:47</div></div>
<div class="ttc" id="anamespaceneml2_html_a3c266b437e28eb7adec97c12b9a7e7d2"><div class="ttname"><a href="namespaceneml2.html#a3c266b437e28eb7adec97c12b9a7e7d2">neml2::set_default_dtype</a></div><div class="ttdeci">void set_default_dtype(Dtype dtype)</div><div class="ttdef"><b>Definition</b> defaults.cxx:32</div></div>
</div><!-- fragment --><p>Output: </p><div class="fragment"><div class="line">                  velocity: state/v</div>
<div class="line">              acceleration: state/a</div>
<div class="line">gravitational_acceleration: g</div>
<div class="line">         dynamic_viscosity: mu</div>
</div><!-- fragment --><div class="section_buttons"></div><div class="section_buttons"><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Previous   </th><th class="markdownTableHeadRight">Next    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="tutorials-extension.html">Extension</a>   </td><td class="markdownTableBodyRight"><a class="el" href="tutorials-extension-argument-declaration.html">Argument declaration</a>   </td></tr>
</table>
</div><div class="section_buttons"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
