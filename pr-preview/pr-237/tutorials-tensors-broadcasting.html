<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.13.2" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: Broadcasting</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorials-tensors-broadcasting.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Broadcasting</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md132">NEML2&#39;s broadcasting rules</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md133">Example</a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_content_2tutorials_2tensors_2broadcasting_2main"></a></p>
<p>Related reading: NumPy manual on <a href="https://numpy.org/doc/stable/user/basics.broadcasting.html">Broadcasting</a></p>
<h1><a class="anchor" id="autotoc_md132"></a>
NEML2's broadcasting rules</h1>
<p>NEML's broadcasting rules are built on top of NumPy's general broadcasting rules.</p>
<p>When operating on two tensors, NEML2 compares each dimension's size pair one-by-one, from right to left. Before the comparison, the shapes of two tensors are aligned at the final batch dimension. The comparison starts with the trailing (i.e., rightmost) batch dimension and works its way left. Two batch dimensions are compatible (broadcastable) when</p><ul>
<li>Their sizes are equal,</li>
<li>One of them has size one, or</li>
<li>One of them does not exist.</li>
</ul>
<p>If all dimensions are compatible, the two tensors are <em>batch-broadcastable</em>. Many operations in NEML2 require operands to be batch-broadcastable, and if not, an exception will be thrown (typically only in Debug mode).</p>
<p>The operands do not need to have the same batch dimension (per the third rule) in order to be batch-broadcastable. After broadcasting, each dimension of the operands are effectively expanded to have the same size as larger size of the two.</p>
<p>Note that we have not yet mentioned anything about the broadcasting rules for base dimensions, because the requirement for operands' base shapes largely depend on the operation itself. And for all primitive tensor types, since the base shapes are determined statically, no shape check is needed at runtime.</p>
<h1><a class="anchor" id="autotoc_md133"></a>
Example</h1>
<p>The utility of broadcasting is best demonstrated with practical examples.</p>
<p>Suppose we are given two samples made of different materials, and for each sample, we are given a number of strain measurements at different locations. Assuming both materials are homogeneous, we could utilize NEML2's broadcasting rules to perform the constitutive update extremely efficiently.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;torch/torch.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/SSR4.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/SR2.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/Scalar.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  <a class="code hl_function" href="namespaceneml2.html#a3c266b437e28eb7adec97c12b9a7e7d2">set_default_dtype</a>(<a class="code hl_variable" href="namespaceneml2.html#a16c96ec35672a72196d72131d3f5f8c3">kFloat64</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Number of samples</span></div>
<div class="line">  <a class="code hl_typedef" href="namespaceneml2.html#a90023c4b9c19cd471d4603a07a52954e">Size</a> ns = 2;</div>
<div class="line">  <span class="comment">// Number of strain measurements</span></div>
<div class="line">  <a class="code hl_typedef" href="namespaceneml2.html#a90023c4b9c19cd471d4603a07a52954e">Size</a> nm = 1000;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Elasticity tensor of the two materials</span></div>
<div class="line">  <span class="keyword">auto</span> youngs_modulus = <a class="code hl_function" href="classneml2_1_1PrimitiveTensor.html#a4fa60a5b1eafb6b62114739bee97d497">Scalar::create</a>({1e5, 2e5});</div>
<div class="line">  <span class="keyword">auto</span> poissons_ratio = <a class="code hl_function" href="classneml2_1_1PrimitiveTensor.html#a4fa60a5b1eafb6b62114739bee97d497">Scalar::create</a>({0.1, 0.2});</div>
<div class="line">  <span class="keyword">auto</span> C = <a class="code hl_function" href="classneml2_1_1SSR4.html#ad318e161a620ac1bb046547a9151d421">SSR4::isotropic_E_nu</a>(youngs_modulus, poissons_ratio);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// (Fake) strain measurements</span></div>
<div class="line">  <span class="keyword">auto</span> strain = <a class="code hl_class" href="classneml2_1_1SR2.html">SR2</a>(torch::rand({nm, ns, 6}, <a class="code hl_variable" href="namespaceneml2.html#a16c96ec35672a72196d72131d3f5f8c3">kFloat64</a>));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Perform the constitutive update</span></div>
<div class="line">  <span class="keyword">auto</span> stress = C * strain;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Do the shapes make sense?</span></div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;     Shape of C:&quot;</span> &lt;&lt; C.<a class="code hl_function" href="classneml2_1_1TensorBase.html#aaca47ed740b50705766d2aa3d5551f22">batch_sizes</a>() &lt;&lt; C.base_sizes() &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Shape of strain: &quot;</span> &lt;&lt; strain.batch_sizes() &lt;&lt; strain.base_sizes() &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Shape of stress: &quot;</span> &lt;&lt; stress.<a class="code hl_function" href="classneml2_1_1TensorBase.html#aaca47ed740b50705766d2aa3d5551f22">batch_sizes</a>() &lt;&lt; stress.<a class="code hl_function" href="classneml2_1_1TensorBase.html#ad119635009e213bf9836d432993113eb">base_sizes</a>() &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1PrimitiveTensor_html_a4fa60a5b1eafb6b62114739bee97d497"><div class="ttname"><a href="classneml2_1_1PrimitiveTensor.html#a4fa60a5b1eafb6b62114739bee97d497">neml2::PrimitiveTensor&lt; Scalar &gt;::create</a></div><div class="ttdeci">static Scalar create(TensorDataContainer data, const TensorOptions &amp;options=default_tensor_options())</div><div class="ttdef"><b>Definition</b> PrimitiveTensor.h:158</div></div>
<div class="ttc" id="aclassneml2_1_1SR2_html"><div class="ttname"><a href="classneml2_1_1SR2.html">neml2::SR2</a></div><div class="ttdoc">The symmetric second order tensor.</div><div class="ttdef"><b>Definition</b> SR2.h:46</div></div>
<div class="ttc" id="aclassneml2_1_1SSR4_html_ad318e161a620ac1bb046547a9151d421"><div class="ttname"><a href="classneml2_1_1SSR4.html#ad318e161a620ac1bb046547a9151d421">neml2::SSR4::isotropic_E_nu</a></div><div class="ttdeci">static SSR4 isotropic_E_nu(const Scalar &amp;E, const Scalar &amp;nu)</div><div class="ttdoc">Create the fourth order elasticity tensor given the Young&#39;s modulus and the Poisson&#39;s ratio.</div><div class="ttdef"><b>Definition</b> SSR4.cxx:117</div></div>
<div class="ttc" id="aclassneml2_1_1TensorBase_html_aaca47ed740b50705766d2aa3d5551f22"><div class="ttname"><a href="classneml2_1_1TensorBase.html#aaca47ed740b50705766d2aa3d5551f22">neml2::TensorBase::batch_sizes</a></div><div class="ttdeci">const TraceableTensorShape &amp; batch_sizes() const</div><div class="ttdoc">Return the batch size.</div><div class="ttdef"><b>Definition</b> TensorBaseImpl.h:178</div></div>
<div class="ttc" id="aclassneml2_1_1TensorBase_html_ad119635009e213bf9836d432993113eb"><div class="ttname"><a href="classneml2_1_1TensorBase.html#ad119635009e213bf9836d432993113eb">neml2::TensorBase::base_sizes</a></div><div class="ttdeci">TensorShapeRef base_sizes() const</div><div class="ttdoc">Return the base size.</div><div class="ttdef"><b>Definition</b> TensorBaseImpl.h:198</div></div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> DiagnosticsInterface.cxx:30</div></div>
<div class="ttc" id="anamespaceneml2_html_a16c96ec35672a72196d72131d3f5f8c3"><div class="ttname"><a href="namespaceneml2.html#a16c96ec35672a72196d72131d3f5f8c3">neml2::kFloat64</a></div><div class="ttdeci">constexpr auto kFloat64</div><div class="ttdef"><b>Definition</b> types.h:53</div></div>
<div class="ttc" id="anamespaceneml2_html_a3c266b437e28eb7adec97c12b9a7e7d2"><div class="ttname"><a href="namespaceneml2.html#a3c266b437e28eb7adec97c12b9a7e7d2">neml2::set_default_dtype</a></div><div class="ttdeci">void set_default_dtype(Dtype dtype)</div><div class="ttdef"><b>Definition</b> defaults.cxx:32</div></div>
<div class="ttc" id="anamespaceneml2_html_a90023c4b9c19cd471d4603a07a52954e"><div class="ttname"><a href="namespaceneml2.html#a90023c4b9c19cd471d4603a07a52954e">neml2::Size</a></div><div class="ttdeci">int64_t Size</div><div class="ttdef"><b>Definition</b> types.h:69</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">     Shape of C:[2][6, 6]</div>
<div class="line">Shape of strain: [1000, 2][6]</div>
<div class="line">Shape of stress: [1000, 2][6]</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> torch</div>
<div class="line"><span class="keyword">from</span> neml2.tensors <span class="keyword">import</span> Scalar, SR2, SSR4</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Number of samples</span></div>
<div class="line">ns = 2</div>
<div class="line"><span class="comment"># Number of strain measurements</span></div>
<div class="line">nm = 1000</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Elasticity tensor of the two materials</span></div>
<div class="line">youngs_modulus = Scalar(torch.tensor([1e5, 2e5], dtype=torch.float64))</div>
<div class="line">poissons_ratio = Scalar(torch.tensor([0.1, 0.2], dtype=torch.float64))</div>
<div class="line">C = SSR4.isotropic_E_nu(youngs_modulus, poissons_ratio)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># (Fake) strain measurements</span></div>
<div class="line">strain = SR2(torch.rand(nm, ns, 6, dtype=torch.float64))</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Perform the constitutive update</span></div>
<div class="line">stress = C * strain</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Do the shapes make sense?</span></div>
<div class="line">print(<span class="stringliteral">&quot;     Shape of C:&quot;</span>, C.batch.shape, C.base.shape)</div>
<div class="line">print(<span class="stringliteral">&quot;Shape of strain:&quot;</span>, strain.batch.shape, strain.base.shape)</div>
<div class="line">print(<span class="stringliteral">&quot;Shape of stress:&quot;</span>, stress.batch.shape, stress.base.shape)</div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">     Shape of C: (2,) (6, 6)</div>
<div class="line">Shape of strain: (1000, 2) (6,)</div>
<div class="line">Shape of stress: (1000, 2) (6,)</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><p>To better understand broadcasting, let us try to apply the broadcasting rules manually:</p><ol type="1">
<li>Align the shapes at the final batch dimension (i.e., align the semicolons): <div class="fragment"><div class="line">Shape of C:            (2; 6, 6)</div>
<div class="line">Shape of strain: (1000, 2; 6)</div>
</div><!-- fragment --></li>
<li>Examine batch sizes from right to left: <div class="fragment"><div class="line">Shape of C:            (2; 6, 6)</div>
<div class="line">Shape of strain: (1000, 2; 6)</div>
<div class="line">                        ▲</div>
</div><!-- fragment --> The sizes are equal &ndash; the two operands are compatible at the final batch dimension.</li>
<li>Continue to the next batch dimension: <div class="fragment"><div class="line">Shape of C:            (2; 6, 6)</div>
<div class="line">Shape of strain: (1000, 2; 6)</div>
<div class="line">                     ▲</div>
</div><!-- fragment --> One of the size does not exist &ndash; the two operands are compatible at the second last batch dimension.</li>
<li>All batch dimensions are compatible, therefore the two operands are <em>batch-broadcastable</em>.</li>
<li>The resulting batch shapes are effectively the "expand" of the two: <div class="fragment"><div class="line">Shape of C:      (1000, 2; 6, 6)</div>
<div class="line">                     ▲</div>
<div class="line">                     expanded (without copying)</div>
<div class="line">Shape of strain: (1000, 2; 6)</div>
</div><!-- fragment --></li>
</ol>
<div class="section_buttons"></div><div class="section_buttons"><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Previous   </th><th class="markdownTableHeadRight">Next    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="tutorials-tensors-tensor-view.html">Tensor view</a>   </td><td class="markdownTableBodyRight"><a class="el" href="tutorials-tensors.html">Tensors</a>   </td></tr>
</table>
</div><div class="section_buttons"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
