<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.12.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: Just-in-time compilation</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeInteractiveToc.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorials-models-just-in-time-compilation.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Just-in-time compilation</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md104">Problem description</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md105">Model structure</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md106">Tracing</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md107">JIT optimization</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md108">Limitations</a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_content_2tutorials_2models_2just__in__time__compilation_2main"></a></p>
<h1><a class="anchor" id="autotoc_md104"></a>
Problem description</h1>
<p>In NEML2, all tensor operations are traceable. The trace of an operation records the operator type, a stack of arguments and outputs, together with additional context. Multiple operations performed in sequence can be traced together into a <em>graph</em> representing the flow of data through operators. Such graph representation is primarily used for two purposes:</p><ul>
<li>Just-in-time (JIT) compilation and optimization of the operations</li>
<li>Backward automatic-differentiation (AD)</li>
</ul>
<p>This tutorial illustrates the utility of JIT compilation of NEML2 models, and a <a class="el" href="tutorials-optimization-automatic-differentiation.html">later tutorial</a> demonstrates the use of backward AD to calculate parameter derivatives.</p>
<p>In this tutorial, let us consider the following problem     </p><p class="formulaDsp">
\begin{align}
  \dot{a} &amp; = \dfrac{a - a_n}{t - t_n}, \label{1} \\
  \dot{b} &amp; = \dfrac{b - b_n}{t - t_n}, \label{2} \\
  \dot{c} &amp; = \dfrac{c - c_n}{t - t_n}, \label{3}
\end{align}
</p>
<p> where the subscript \( n \) represents the variable value from the previous time step.</p>
<h1><a class="anchor" id="autotoc_md105"></a>
Model structure</h1>
<p>All three equations can be translated to <a class="el" href="syntax-models.html#scalarvariablerate">ScalarVariableRate</a>. The input file looks like </p><div class="fragment"><div class="line">[Models]</div>
<div class="line">  [eq1]</div>
<div class="line">    type = ScalarVariableRate</div>
<div class="line">    variable = &#39;state/a&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq2]</div>
<div class="line">    type = ScalarVariableRate</div>
<div class="line">    variable = &#39;state/b&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq3]</div>
<div class="line">    type = ScalarVariableRate</div>
<div class="line">    variable = &#39;state/c&#39;</div>
<div class="line">  []</div>
<div class="line">  [eq]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = &#39;eq1 eq2 eq3&#39;</div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p> And the composed model correctly defines \( a \), \( a_n \), \( b \), \( b_n \), \( c \), \( c_n \), \( t \), \( t_n \) as input variables and \( \dot{a} \), \( \dot{b} \), \( \dot{c} \) as output variables.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  <span class="keyword">auto</span> model = load_model(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>);</div>
<div class="line">  std::cout &lt;&lt; *model &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> DiagnosticsInterface.cxx:30</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">Name:       eq</div>
<div class="line">Input:      forces/t [Scalar]</div>
<div class="line">            old_forces/t [Scalar]</div>
<div class="line">            old_state/a [Scalar]</div>
<div class="line">            old_state/b [Scalar]</div>
<div class="line">            old_state/c [Scalar]</div>
<div class="line">            state/a [Scalar]</div>
<div class="line">            state/b [Scalar]</div>
<div class="line">            state/c [Scalar]</div>
<div class="line">Output:     state/a_rate [Scalar]</div>
<div class="line">            state/b_rate [Scalar]</div>
<div class="line">            state/c_rate [Scalar]</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"> </div>
<div class="line">model = <a class="code hl_function" href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2.load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>)</div>
<div class="line">print(model)</div>
<div class="ttc" id="anamespaceneml2_html_aa98735f2ffd7c3ae8b0b339621eb8ab3"><div class="ttname"><a href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2::load_model</a></div><div class="ttdeci">std::shared_ptr&lt; Model &gt; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> Model.cxx:43</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">Name:       eq</div>
<div class="line">Input:      forces/t [Scalar]</div>
<div class="line">            old_forces/t [Scalar]</div>
<div class="line">            old_state/a [Scalar]</div>
<div class="line">            old_state/b [Scalar]</div>
<div class="line">            old_state/c [Scalar]</div>
<div class="line">            state/a [Scalar]</div>
<div class="line">            state/b [Scalar]</div>
<div class="line">            state/c [Scalar]</div>
<div class="line">Output:     state/a_rate [Scalar]</div>
<div class="line">            state/b_rate [Scalar]</div>
<div class="line">            state/c_rate [Scalar]</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><h1><a class="anchor" id="autotoc_md106"></a>
Tracing</h1>
<p>NEML2 enables tracing of tensor operations lazily. No tracing is performed when the model is first loaded from the input file. Tracing takes place when the model is being evaluated for the first time. The following code can be used to view the traced graph in text format.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/Scalar.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/jit/utils.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  set_default_dtype(kFloat64);</div>
<div class="line">  <span class="keyword">auto</span> model = load_model(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create example input variables for tracing</span></div>
<div class="line">  <span class="keyword">auto</span> a = Scalar::full(1.0);</div>
<div class="line">  <span class="keyword">auto</span> b = Scalar::full(2.0);</div>
<div class="line">  <span class="keyword">auto</span> c = Scalar::full(3.0);</div>
<div class="line">  <span class="keyword">auto</span> t = Scalar::full(0.1);</div>
<div class="line">  <span class="keyword">auto</span> a_n = Scalar::full(0.0);</div>
<div class="line">  <span class="keyword">auto</span> b_n = Scalar::full(1.0);</div>
<div class="line">  <span class="keyword">auto</span> c_n = Scalar::full(2.0);</div>
<div class="line">  <span class="keyword">auto</span> t_n = Scalar::full(0.0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Evaluate the model for the first time</span></div>
<div class="line">  <span class="comment">// This is when tracing takes place</span></div>
<div class="line">  model-&gt;value({{<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>), a},</div>
<div class="line">                {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>), b},</div>
<div class="line">                {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;c&quot;</span>), c},</div>
<div class="line">                {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;t&quot;</span>), t},</div>
<div class="line">                {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_state&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>), a_n},</div>
<div class="line">                {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_state&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>), b_n},</div>
<div class="line">                {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_state&quot;</span>, <span class="stringliteral">&quot;c&quot;</span>), c_n},</div>
<div class="line">                {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_forces&quot;</span>, <span class="stringliteral">&quot;t&quot;</span>), t_n}});</div>
<div class="line"> </div>
<div class="line">  utils::last_executed_optimized_graph()-&gt;dump();</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1LabeledAxisAccessor_html"><div class="ttname"><a href="classneml2_1_1LabeledAxisAccessor.html">neml2::LabeledAxisAccessor</a></div><div class="ttdoc">The accessor containing all the information needed to access an item in a LabeledAxis.</div><div class="ttdef"><b>Definition</b> LabeledAxisAccessor.h:56</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">graph(%eq::forces/t : Tensor,</div>
<div class="line">      %eq::old_forces/t : Tensor,</div>
<div class="line">      %eq::old_state/a : Tensor,</div>
<div class="line">      %eq::old_state/b : Tensor,</div>
<div class="line">      %eq::old_state/c : Tensor,</div>
<div class="line">      %eq::state/a : Tensor,</div>
<div class="line">      %eq::state/b : Tensor,</div>
<div class="line">      %eq::state/c : Tensor):</div>
<div class="line">  %8 : int = prim::Constant[value=1]()</div>
<div class="line">  %9 : Tensor = prim::Constant[value= 1  1  1 [ CPULongType{3} ]]()</div>
<div class="line">  %18 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::state/a)</div>
<div class="line">  %19 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_state/a)</div>
<div class="line">  %10 : Tensor = aten::sub(%18, %19, %8)</div>
<div class="line">  %20 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::forces/t)</div>
<div class="line">  %21 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_forces/t)</div>
<div class="line">  %11 : Tensor = aten::sub(%20, %21, %8)</div>
<div class="line">  %22 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%10)</div>
<div class="line">  %23 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%11)</div>
<div class="line">  %12 : Tensor = aten::div(%22, %23)</div>
<div class="line">  %24 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::state/b)</div>
<div class="line">  %25 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_state/b)</div>
<div class="line">  %13 : Tensor = aten::sub(%24, %25, %8)</div>
<div class="line">  %26 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%13)</div>
<div class="line">  %27 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%11)</div>
<div class="line">  %14 : Tensor = aten::div(%26, %27)</div>
<div class="line">  %28 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::state/c)</div>
<div class="line">  %29 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_state/c)</div>
<div class="line">  %15 : Tensor = aten::sub(%28, %29, %8)</div>
<div class="line">  %30 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%15)</div>
<div class="line">  %31 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%11)</div>
<div class="line">  %16 : Tensor = aten::div(%30, %31)</div>
<div class="line">  %32 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%12)</div>
<div class="line">  %33 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%14)</div>
<div class="line">  %34 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%16)</div>
<div class="line">  %35 : Tensor = prim::profile[profiled_type=Long(3, strides=[1], requires_grad=0, device=cpu), seen_none=0](%9)</div>
<div class="line">  %17 : Tensor[] = prim::ListConstruct(%32, %33, %34, %35)</div>
<div class="line">   = prim::profile()</div>
<div class="line">  return (%17)</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> neml2.tensors <span class="keyword">import</span> Scalar</div>
<div class="line"><span class="keyword">import</span> torch</div>
<div class="line"> </div>
<div class="line">torch.set_default_dtype(torch.double)</div>
<div class="line">model = <a class="code hl_function" href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2.load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create example input variables for tracing</span></div>
<div class="line">a = Scalar.full(1.0)</div>
<div class="line">b = Scalar.full(2.0)</div>
<div class="line">c = Scalar.full(3.0)</div>
<div class="line">t = Scalar.full(0.1)</div>
<div class="line">a_n = Scalar.full(0.0)</div>
<div class="line">b_n = Scalar.full(1.0)</div>
<div class="line">c_n = Scalar.full(2.0)</div>
<div class="line">t_n = Scalar.full(0.0)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Evaluate the model for the first time</span></div>
<div class="line"><span class="comment"># This is when tracing takes place</span></div>
<div class="line">model.value({<span class="stringliteral">&quot;state/a&quot;</span>: a,</div>
<div class="line">             <span class="stringliteral">&quot;state/b&quot;</span>: b,</div>
<div class="line">             <span class="stringliteral">&quot;state/c&quot;</span>: c,</div>
<div class="line">             <span class="stringliteral">&quot;forces/t&quot;</span>: t,</div>
<div class="line">             <span class="stringliteral">&quot;old_state/a&quot;</span>: a_n,</div>
<div class="line">             <span class="stringliteral">&quot;old_state/b&quot;</span>: b,</div>
<div class="line">             <span class="stringliteral">&quot;old_state/c&quot;</span>: c,</div>
<div class="line">             <span class="stringliteral">&quot;old_forces/t&quot;</span>: t})</div>
<div class="line"> </div>
<div class="line">print(torch.jit.last_executed_optimized_graph())</div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">graph(%eq::forces/t : Tensor,</div>
<div class="line">      %eq::old_forces/t : Tensor,</div>
<div class="line">      %eq::old_state/a : Tensor,</div>
<div class="line">      %eq::old_state/b : Tensor,</div>
<div class="line">      %eq::old_state/c : Tensor,</div>
<div class="line">      %eq::state/a : Tensor,</div>
<div class="line">      %eq::state/b : Tensor,</div>
<div class="line">      %eq::state/c : Tensor):</div>
<div class="line">  %8 : int = prim::Constant[value=1]() # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %9 : Tensor = prim::Constant[value= 1  1  1 [ CPULongType{3} ]]() # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %18 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::state/a)</div>
<div class="line">  %19 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_state/a)</div>
<div class="line">  %10 : Tensor = aten::sub(%18, %19, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %20 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::forces/t)</div>
<div class="line">  %21 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_forces/t)</div>
<div class="line">  %11 : Tensor = aten::sub(%20, %21, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %22 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%10)</div>
<div class="line">  %23 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%11)</div>
<div class="line">  %12 : Tensor = aten::div(%22, %23) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %24 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::state/b)</div>
<div class="line">  %25 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_state/b)</div>
<div class="line">  %13 : Tensor = aten::sub(%24, %25, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %26 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%13)</div>
<div class="line">  %27 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%11)</div>
<div class="line">  %14 : Tensor = aten::div(%26, %27) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %28 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::state/c)</div>
<div class="line">  %29 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_state/c)</div>
<div class="line">  %15 : Tensor = aten::sub(%28, %29, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %30 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%15)</div>
<div class="line">  %31 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%11)</div>
<div class="line">  %16 : Tensor = aten::div(%30, %31) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src4.py:17:0</div>
<div class="line">  %32 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%12)</div>
<div class="line">  %33 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%14)</div>
<div class="line">  %34 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%16)</div>
<div class="line">  %35 : Tensor = prim::profile[profiled_type=Long(3, strides=[1], requires_grad=0, device=cpu), seen_none=0](%9)</div>
<div class="line">  %17 : Tensor[] = prim::ListConstruct(%32, %33, %34, %35)</div>
<div class="line">   = prim::profile()</div>
<div class="line">  return (%17)</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><p>Note that the above graph is called a <em>profiling</em> graph. While it is not the most human-friendly to read, let us highlight some lines of the text output to try to associated it with the equations.</p>
<p>The following lines </p><div class="fragment"><div class="line">%18 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::state/a)</div>
<div class="line">%19 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_state/a)</div>
<div class="line">%10 : Tensor = aten::sub(%18, %19, %8)</div>
<div class="line">%20 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::forces/t)</div>
<div class="line">%21 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%eq::old_forces/t)</div>
<div class="line">%11 : Tensor = aten::sub(%20, %21, %8)</div>
<div class="line">%22 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%10)</div>
<div class="line">%23 : Tensor = prim::profile[profiled_type=Double(requires_grad=0, device=cpu), seen_none=0](%11)</div>
<div class="line">%12 : Tensor = aten::div(%22, %23)</div>
</div><!-- fragment --><p> cover three tensor operations: two <code>aten::sub</code>s and one <code>aten::div</code>, which correspond to \( \eqref{1} \). Note that each variable is wrapped inside a profiling node denoted as <code>prim::profile</code>. These wrappers allow the graph executor to record and analyze the runtime statistics of tensor operations, in order to identify hot spots to optimize.</p>
<h1><a class="anchor" id="autotoc_md107"></a>
JIT optimization</h1>
<p>With the profiling graph, further execution of the same traced graph automatically identifies opportunities for optimization. In summary, the following types of optimizations are enabled in NEML2 by default:</p><ul>
<li>Inlining</li>
<li>Constant pooling</li>
<li>Removing expands</li>
<li>Canonicalization</li>
<li>Dead code elimination</li>
<li>Constant propagation</li>
<li>Input shape propagation</li>
<li>Common subexpression extraction</li>
<li>Peephole optimization</li>
<li>Loop unrolling</li>
</ul>
<p>See the <a href="https://github.com/pytorch/pytorch/blob/main/torch/csrc/jit/OVERVIEW.md">PyTorch JIT</a> design document for detailed explanation on each of the optimization pass.</p>
<p>The code below shows that, after a few forward evaluations, the traced graph can be substantially optimized.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/Scalar.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/jit/utils.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  set_default_dtype(kFloat64);</div>
<div class="line">  <span class="keyword">auto</span> model = load_model(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create example input variables for tracing</span></div>
<div class="line">  <span class="keyword">auto</span> a = Scalar::full(1.0);</div>
<div class="line">  <span class="keyword">auto</span> b = Scalar::full(2.0);</div>
<div class="line">  <span class="keyword">auto</span> c = Scalar::full(3.0);</div>
<div class="line">  <span class="keyword">auto</span> t = Scalar::full(0.1);</div>
<div class="line">  <span class="keyword">auto</span> a_n = Scalar::full(0.0);</div>
<div class="line">  <span class="keyword">auto</span> b_n = Scalar::full(1.0);</div>
<div class="line">  <span class="keyword">auto</span> c_n = Scalar::full(2.0);</div>
<div class="line">  <span class="keyword">auto</span> t_n = Scalar::full(0.0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Evaluate the model for multiple times</span></div>
<div class="line">  <span class="keyword">auto</span> inputs = <a class="code hl_typedef" href="namespaceneml2.html#a22b998dd10e5127283599bc49bee5d16">ValueMap</a>({{<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>), a},</div>
<div class="line">                          {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>), b},</div>
<div class="line">                          {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;c&quot;</span>), c},</div>
<div class="line">                          {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;t&quot;</span>), t},</div>
<div class="line">                          {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_state&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>), a_n},</div>
<div class="line">                          {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_state&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>), b_n},</div>
<div class="line">                          {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_state&quot;</span>, <span class="stringliteral">&quot;c&quot;</span>), c_n},</div>
<div class="line">                          {<a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;old_forces&quot;</span>, <span class="stringliteral">&quot;t&quot;</span>), t_n}});</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10; i++)</div>
<div class="line">    model-&gt;value(inputs);</div>
<div class="line"> </div>
<div class="line">  utils::last_executed_optimized_graph()-&gt;dump();</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceneml2_html_a22b998dd10e5127283599bc49bee5d16"><div class="ttname"><a href="namespaceneml2.html#a22b998dd10e5127283599bc49bee5d16">neml2::ValueMap</a></div><div class="ttdeci">std::map&lt; LabeledAxisAccessor, Tensor &gt; ValueMap</div><div class="ttdef"><b>Definition</b> map_types_fwd.h:33</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">graph(%eq::forces/t : Tensor,</div>
<div class="line">      %eq::old_forces/t : Tensor,</div>
<div class="line">      %eq::old_state/a : Tensor,</div>
<div class="line">      %eq::old_state/b : Tensor,</div>
<div class="line">      %eq::old_state/c : Tensor,</div>
<div class="line">      %eq::state/a : Tensor,</div>
<div class="line">      %eq::state/b : Tensor,</div>
<div class="line">      %eq::state/c : Tensor):</div>
<div class="line">  %9 : Long(3, strides=[1], requires_grad=0, device=cpu) = prim::Constant[value= 1  1  1 [ CPULongType{3} ]]()</div>
<div class="line">  %8 : int = prim::Constant[value=1]()</div>
<div class="line">  %12 : Tensor = aten::sub(%eq::state/a, %eq::old_state/a, %8)</div>
<div class="line">  %15 : Tensor = aten::sub(%eq::forces/t, %eq::old_forces/t, %8)</div>
<div class="line">  %18 : Tensor = aten::div(%12, %15)</div>
<div class="line">  %21 : Tensor = aten::sub(%eq::state/b, %eq::old_state/b, %8)</div>
<div class="line">  %24 : Tensor = aten::div(%21, %15)</div>
<div class="line">  %27 : Tensor = aten::sub(%eq::state/c, %eq::old_state/c, %8)</div>
<div class="line">  %30 : Tensor = aten::div(%27, %15)</div>
<div class="line">  %35 : Tensor[] = prim::ListConstruct(%18, %24, %30, %9)</div>
<div class="line">  return (%35)</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> neml2.tensors <span class="keyword">import</span> Scalar</div>
<div class="line"><span class="keyword">import</span> torch</div>
<div class="line"> </div>
<div class="line">torch.set_default_dtype(torch.double)</div>
<div class="line">model = <a class="code hl_function" href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2.load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create example input variables for tracing</span></div>
<div class="line">a = Scalar.full(1.0)</div>
<div class="line">b = Scalar.full(2.0)</div>
<div class="line">c = Scalar.full(3.0)</div>
<div class="line">t = Scalar.full(0.1)</div>
<div class="line">a_n = Scalar.full(0.0)</div>
<div class="line">b_n = Scalar.full(1.0)</div>
<div class="line">c_n = Scalar.full(2.0)</div>
<div class="line">t_n = Scalar.full(0.0)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Evaluate the model for the first time</span></div>
<div class="line"><span class="comment"># This is when tracing takes place</span></div>
<div class="line">inputs = {<span class="stringliteral">&quot;state/a&quot;</span>: a,</div>
<div class="line">         <span class="stringliteral">&quot;state/b&quot;</span>: b,</div>
<div class="line">         <span class="stringliteral">&quot;state/c&quot;</span>: c,</div>
<div class="line">         <span class="stringliteral">&quot;forces/t&quot;</span>: t,</div>
<div class="line">         <span class="stringliteral">&quot;old_state/a&quot;</span>: a_n,</div>
<div class="line">         <span class="stringliteral">&quot;old_state/b&quot;</span>: b,</div>
<div class="line">         <span class="stringliteral">&quot;old_state/c&quot;</span>: c,</div>
<div class="line">         <span class="stringliteral">&quot;old_forces/t&quot;</span>: t}</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(10):</div>
<div class="line">  model.value(inputs)</div>
<div class="line"> </div>
<div class="line">print(torch.jit.last_executed_optimized_graph())</div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">graph(%eq::forces/t : Tensor,</div>
<div class="line">      %eq::old_forces/t : Tensor,</div>
<div class="line">      %eq::old_state/a : Tensor,</div>
<div class="line">      %eq::old_state/b : Tensor,</div>
<div class="line">      %eq::old_state/c : Tensor,</div>
<div class="line">      %eq::state/a : Tensor,</div>
<div class="line">      %eq::state/b : Tensor,</div>
<div class="line">      %eq::state/c : Tensor):</div>
<div class="line">  %9 : Long(3, strides=[1], requires_grad=0, device=cpu) = prim::Constant[value= 1  1  1 [ CPULongType{3} ]]() # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %8 : int = prim::Constant[value=1]() # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %12 : Tensor = aten::sub(%eq::state/a, %eq::old_state/a, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %15 : Tensor = aten::sub(%eq::forces/t, %eq::old_forces/t, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %18 : Tensor = aten::div(%12, %15) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %21 : Tensor = aten::sub(%eq::state/b, %eq::old_state/b, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %24 : Tensor = aten::div(%21, %15) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %27 : Tensor = aten::sub(%eq::state/c, %eq::old_state/c, %8) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %30 : Tensor = aten::div(%27, %15) # /home/runner/work/neml2/neml2/build/dev/doc/content/tutorials/models/just_in_time_compilation/src6.py:26:0</div>
<div class="line">  %35 : Tensor[] = prim::ListConstruct(%18, %24, %30, %9)</div>
<div class="line">  return (%35)</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><p>Note how the optimized graph successfully identifies the common subexpression \( t - t_n \) and reuses it in all three equations.</p>
<h1><a class="anchor" id="autotoc_md108"></a>
Limitations</h1>
<p>JIT optimization and compilation isn't the holy grail for improving performance of all models. For tensor operations that branch based on variable data, the traced graph cannot capture such data dependency and would potentially produce wrong results. NEML2 is unable to generate traced graphs for models that include derivatives of other models in the forward evaluation when those derivatives are defined with automatic differentiation.</p>
<p>Due to these limitations, certain models disable the use of JIT compilation. The most notable case is <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> due to its use of Newton-Raphson solvers which are in general data dependent. However, the portions of the complete model defining the implicit function to solve can often benefit from JIT compilation.</p>
<p>When multiple models are composed together, a single function graph is by default traced through all sub-models. However, if one of the sub-model does not allow JIT, e.g., is of type <code>ImplicitUpdate</code>, then the composed model falls back to trace each individual sub-model except for those explicitly disabling JIT. Therefore, it is generally recommended to compose JIT-enabled sub-models separate from those JIT-disabled ones, allowing for more optimization opportunities.</p>
<div class="section_buttons"></div><div class="section_buttons"><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Previous   </th><th class="markdownTableHeadRight">Next    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="tutorials-models-transient-driver.html">Transient driver</a>   </td><td class="markdownTableBodyRight"><a class="el" href="tutorials-models.html">Models</a>   </td></tr>
</table>
</div><div class="section_buttons"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
