<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.13.2" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: Evaluation device</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorials-models-evaluation-device.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Evaluation device</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md88">Device</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md89">Specifying a device</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md90">Evaluating the model on a different device</a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_content_2tutorials_2models_2evaluation__device_2main"></a></p>
<h1><a class="anchor" id="autotoc_md88"></a>
Device</h1>
<p>NEML2 inherits the definition of <em>device</em> from PyTorch. It is an abstraction representing the physical device where data is stored and models executed. NEML2 is primarily concerned with two types of devices: CPU and CUDA.</p><ul>
<li><b>CPU</b> stands for Central Processing Unit, and it tranditionally handles a wide range of scientific computing tasks.</li>
<li><b>CUDA</b> functions as a programming platform that allows a GPU (Graphics Processing Unit) to act as a coprocessor to the CPU to handle specific computing tasks with massive parallelization.</li>
</ul>
<p>NEML2 offers several high-level mechanisms for users to strategically interact with CPU and CUDA.</p>
<h1><a class="anchor" id="autotoc_md89"></a>
Specifying a device</h1>
<p>A device is uniquely identified by a type, which specifies the type of machine it is (e.g. CPU or CUDA GPU), and a device index or ordinal, which identifies the specific compute device when there is more than one of a certain type. The device index is optional, and in its default state represents (abstractly) "the current device". Further, there are two constraints on the value of the device index, if one is explicitly specified:</p><ul>
<li>A negative index represents the current device, a non-negative index represents a specific, concrete device.</li>
<li>When the device type is CPU, the device index must be zero.</li>
</ul>
<p>In NEML2, the device can be specified using either a string or or a predefined device type.</p>
<p>The string follows the schema <code>(cpu|cuda)[:&lt;device-index&gt;]</code>, where <code>cpu</code> or <code>cuda</code> specifies the device type, and <code>:&lt;device-index&gt;</code> optionally specifies a device index. For example, "cpu" represents the CPU and "cuda:1" specifies CUDA with device ID 1.</p>
<p>Two predefined device types are supported:</p><ul>
<li><code><a class="el" href="namespaceneml2.html#af1bcf14cba8c3bce7445b5661fffd658">neml2::kCPU</a></code> which is equivalent to the string "cpu"</li>
<li><code><a class="el" href="namespaceneml2.html#affa60144211a6ab97dca25dabe6b4fd8">neml2::kCUDA</a></code> which is equivalent to the string "cuda" (without device ID specification)</li>
</ul>
<dl class="section remark"><dt>Remarks</dt><dd>In general, the string representation is more flexible and is universally accepted in the input file whenever a device specification is required. Parsing the string, however, inposes a small runtime overhead, and therefore it should be replaced with the corresponding device type (if applicable) in performance-critical regions of your code.</dd></dl>
<h1><a class="anchor" id="autotoc_md90"></a>
Evaluating the model on a different device</h1>
<p>Recall that all models take the general form of \( y = f(x; p, b) \). To invoke the forward operator \( f \) on a different device, the three ingredients \( x \), \( p \), and \( b \) must be allocated on the target device.</p>
<p>In our elasticity example, this breaks down to two tasks:</p><ul>
<li>Allocating the input variable \( \boldsymbol{\varepsilon} \) on the target device.</li>
<li>Sending model parameters \( K \) and \( G \) to the target device.</li>
</ul>
<p>NEML2 uses CPU as the default device. The code below demonstrates how to evaluate the model on CUDA:</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><b class="tab-title">C++</b> <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;torch/cuda.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/SR2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  <a class="code hl_function" href="namespaceneml2.html#a3c266b437e28eb7adec97c12b9a7e7d2">set_default_dtype</a>(<a class="code hl_variable" href="namespaceneml2.html#a16c96ec35672a72196d72131d3f5f8c3">kFloat64</a>);</div>
<div class="line">  <span class="keyword">auto</span> &amp; model = <a class="code hl_function" href="namespaceneml2.html#a1e499dee97d6a66663f60dd4a65b9f1a">load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;my_model&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Pick the device</span></div>
<div class="line">  <span class="keyword">auto</span> device = torch::cuda::is_available() ? <a class="code hl_variable" href="namespaceneml2.html#affa60144211a6ab97dca25dabe6b4fd8">kCUDA</a> : <a class="code hl_variable" href="namespaceneml2.html#af1bcf14cba8c3bce7445b5661fffd658">kCPU</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Send the model parameters to the device</span></div>
<div class="line">  model.to(device);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create the strain on the device</span></div>
<div class="line">  <span class="keyword">auto</span> strain_name = <a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;E&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> strain = <a class="code hl_function" href="classneml2_1_1SR2.html#afeaa38df3cc24a16ef450732eddae0d7">SR2::fill</a>(0.1, 0.05, -0.03, 0.02, 0.06, 0.03, device);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Evaluate the model</span></div>
<div class="line">  <span class="keyword">auto</span> output = model.value({{strain_name, strain}});</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get the stress back to CPU</span></div>
<div class="line">  <span class="keyword">auto</span> stress_name = <a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;S&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> stress = output[stress_name].to(<a class="code hl_variable" href="namespaceneml2.html#af1bcf14cba8c3bce7445b5661fffd658">kCPU</a>);</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1SR2_html_afeaa38df3cc24a16ef450732eddae0d7"><div class="ttname"><a href="classneml2_1_1SR2.html#afeaa38df3cc24a16ef450732eddae0d7">neml2::SR2::fill</a></div><div class="ttdeci">static SR2 fill(const Real &amp;a, const TensorOptions &amp;options=default_tensor_options())</div><div class="ttdoc">Fill the diagonals with a11 = a22 = a33 = a.</div><div class="ttdef"><b>Definition</b> SR2.cxx:53</div></div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> DiagnosticsInterface.cxx:30</div></div>
<div class="ttc" id="anamespaceneml2_html_a16c96ec35672a72196d72131d3f5f8c3"><div class="ttname"><a href="namespaceneml2.html#a16c96ec35672a72196d72131d3f5f8c3">neml2::kFloat64</a></div><div class="ttdeci">constexpr auto kFloat64</div><div class="ttdef"><b>Definition</b> types.h:53</div></div>
<div class="ttc" id="anamespaceneml2_html_a1e499dee97d6a66663f60dd4a65b9f1a"><div class="ttname"><a href="namespaceneml2.html#a1e499dee97d6a66663f60dd4a65b9f1a">neml2::load_model</a></div><div class="ttdeci">Model &amp; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> Model.cxx:47</div></div>
<div class="ttc" id="anamespaceneml2_html_a3c266b437e28eb7adec97c12b9a7e7d2"><div class="ttname"><a href="namespaceneml2.html#a3c266b437e28eb7adec97c12b9a7e7d2">neml2::set_default_dtype</a></div><div class="ttdeci">void set_default_dtype(Dtype dtype)</div><div class="ttdef"><b>Definition</b> defaults.cxx:32</div></div>
<div class="ttc" id="anamespaceneml2_html_a9e1488821b46ffc106c90ab80036b7aa"><div class="ttname"><a href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">neml2::VariableName</a></div><div class="ttdeci">LabeledAxisAccessor VariableName</div><div class="ttdef"><b>Definition</b> LabeledAxisAccessor.h:185</div></div>
<div class="ttc" id="anamespaceneml2_html_af1bcf14cba8c3bce7445b5661fffd658"><div class="ttname"><a href="namespaceneml2.html#af1bcf14cba8c3bce7445b5661fffd658">neml2::kCPU</a></div><div class="ttdeci">constexpr auto kCPU</div><div class="ttdef"><b>Definition</b> types.h:56</div></div>
<div class="ttc" id="anamespaceneml2_html_affa60144211a6ab97dca25dabe6b4fd8"><div class="ttname"><a href="namespaceneml2.html#affa60144211a6ab97dca25dabe6b4fd8">neml2::kCUDA</a></div><div class="ttdeci">constexpr auto kCUDA</div><div class="ttdef"><b>Definition</b> types.h:57</div></div>
</div><!-- fragment --></li>
<li><b class="tab-title">Python</b> <div class="fragment"><div class="line"><span class="keyword">import</span> torch</div>
<div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> neml2.tensors <span class="keyword">import</span> SR2</div>
<div class="line"> </div>
<div class="line">torch.set_default_dtype(torch.double)</div>
<div class="line">model = <a class="code hl_function" href="namespaceneml2.html#a1e499dee97d6a66663f60dd4a65b9f1a">neml2.load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;my_model&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Pick the device</span></div>
<div class="line">device = torch.device(<span class="stringliteral">&quot;cuda&quot;</span>) <span class="keywordflow">if</span> torch.cuda.is_available() <span class="keywordflow">else</span> torch.device(<span class="stringliteral">&quot;cpu&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Send the model parameters to the device</span></div>
<div class="line">model.to(device=device)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create the strain on the device</span></div>
<div class="line">strain = SR2.fill(0.1, 0.05, -0.03, 0.02, 0.06, 0.03, device=device)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Evaluate the model</span></div>
<div class="line">output = model.value({<span class="stringliteral">&quot;forces/E&quot;</span>: strain})</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Get the stress back to CPU</span></div>
<div class="line">stress = output[<span class="stringliteral">&quot;state/S&quot;</span>].to(device=torch.device(<span class="stringliteral">&quot;cpu&quot;</span>))</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><div class="section_buttons"></div><div class="section_buttons"><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Previous   </th><th class="markdownTableHeadRight">Next    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="tutorials-models-model-parameters.html">Model parameters</a>   </td><td class="markdownTableBodyRight"><a class="el" href="tutorials-models-vectorization.html">Vectorization</a>   </td></tr>
</table>
</div><div class="section_buttons"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
