<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.12.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: Model composition</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeInteractiveToc.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorials-models-model-composition.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Model composition</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md109">Problem description</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md110">Writing the input file</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md111">Evaluating the models: The hard way</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md112">Evaluating the models: The easy way</a>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_content_2tutorials_2models_2model__composition_2main"></a></p>
<h1><a class="anchor" id="autotoc_md109"></a>
Problem description</h1>
<p>We have been working with the linear, isotropic elasticity model in the previous tutorials. We started with that example because it is arguably the simplest possible material model in the context of solid mechanics. It is simple not just because of the simplicity in the description of the material behavior, but also due to the fact that its mathematical formulation only involves one linear equation.</p>
<p>Much more complicated, nonlinear models can be created using NEML2.</p>
<p>Using a Perzyna-type viscoplasticity model as an example, it can be formulated as         </p><p class="formulaDsp">
\begin{align*}
  \boldsymbol{\varepsilon}^e &amp; = \boldsymbol{\varepsilon} - \boldsymbol{\varepsilon}^p, \\
  \boldsymbol{\sigma} &amp; = 3K\operatorname{vol}\boldsymbol{\varepsilon}^e + 2G\operatorname{dev}\boldsymbol{\varepsilon}^e, \\
  \bar{\sigma} &amp; = J_2(\boldsymbol{\sigma}), \\
  f^p &amp; = \bar{\sigma} - \sigma_y, \\
  \boldsymbol{N} &amp; = \pdv{f^p}{\boldsymbol{\sigma}}, \\
  \dot{\gamma} &amp; = \left( \dfrac{\left&lt; f^p \right&gt;}{\eta} \right)^n, \\
  \dot{\boldsymbol{\varepsilon}}^p &amp; = \dot{\gamma} \boldsymbol{N}.
\end{align*}
</p>
<p> The above formulation makes a series of <em>constitutive choices</em>:</p><ul>
<li>The strain is small and can be additively decomposed into elastic and plastic strains.</li>
<li>The elastic response is linear and isotropic.</li>
<li>The plastic flow is isochoric.</li>
<li>There is no isotropic hardening associated with plasticity.</li>
<li>There is no kinematic hardening associated with plasticity.</li>
<li>There is no back stress associated with plasticity.</li>
<li>The plastic flow is associative.</li>
<li>The plastic rate-sensitivity follows a power-law relation.</li>
</ul>
<p>Any change in one of the constitutive choices will result in a new material model. Suppose there are a total of \( N \) constitutive choices, each having \( k \) variants, the total number of possible material models would be \( k^N \).</p>
<p>In other words, the number of possible material models grows <em>exponentially</em> with the number of constitutive choices, and implementing all combinations is practically infeasible.</p>
<p>To address such challenge, NEML2 introduces a <em>model composition</em> mechanism which allows multiple models to be "stitched" together in a flexible, modular manner.</p>
<p>This tutorial demonstrates model composition using a much simplified model (without loss of generality). The model can be written as     </p><p class="formulaDsp">
\begin{align}
  \bar{a} &amp; = I_1(\boldsymbol{a}), \label{1} \\
  \bar{b} &amp; = J_2(\boldsymbol{b}), \label{2} \\
  \dot{b} &amp; = \bar{b} \boldsymbol{a} + \bar{a} \boldsymbol{b}, \label{3}
\end{align}
</p>
<p> where \( \boldsymbol{a} \) and \( \boldsymbol{b} \) are symmetric second order tensors.</p>
<h1><a class="anchor" id="autotoc_md110"></a>
Writing the input file</h1>
<p>Let us first search for available models describing this set of equations:</p><ul>
<li>\( \eqref{1} \&amp; \eqref{2} \) correspond to <a class="el" href="syntax-models.html#sr2invariant">SR2Invariant</a>;</li>
<li>\( \eqref{3} \) corresponds to <a class="el" href="syntax-models.html#sr2linearcombination">LinearCombination</a>.</li>
</ul>
<p>The input file then looks like </p><div class="fragment"><div class="line">[Models]</div>
<div class="line">  [eq1]</div>
<div class="line">    type = SR2Invariant</div>
<div class="line">    tensor = &#39;forces/a&#39;</div>
<div class="line">    invariant = &#39;state/a_bar&#39;</div>
<div class="line">    invariant_type = I1</div>
<div class="line">  []</div>
<div class="line">  [eq2]</div>
<div class="line">    type = SR2Invariant</div>
<div class="line">    tensor = &#39;state/b&#39;</div>
<div class="line">    invariant = &#39;state/b_bar&#39;</div>
<div class="line">    invariant_type = VONMISES</div>
<div class="line">  []</div>
<div class="line">  [eq3]</div>
<div class="line">    type = SR2LinearCombination</div>
<div class="line">    from_var = &#39;forces/a state/b&#39;</div>
<div class="line">    to_var = &#39;state/b_rate&#39;</div>
<div class="line">    coefficients = &#39;1 1&#39;</div>
<div class="line">    coefficient_as_parameter = true</div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md111"></a>
Evaluating the models: The hard way</h1>
<p>Now that all three models are defined in the input file, we can load and evaluate them in sequence, with a bit of effort:</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/SR2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  set_default_dtype(kFloat64);</div>
<div class="line">  <span class="keyword">auto</span> factory = load_input(<span class="stringliteral">&quot;input.i&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eq1 = factory-&gt;get_model(<span class="stringliteral">&quot;eq1&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eq2 = factory-&gt;get_model(<span class="stringliteral">&quot;eq2&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eq3 = factory-&gt;get_model(<span class="stringliteral">&quot;eq3&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create the input variables</span></div>
<div class="line">  <span class="keyword">auto</span> a_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> b_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> a = SR2::fill(0.1, 0.05, -0.03, 0.02, 0.06, 0.03);</div>
<div class="line">  <span class="keyword">auto</span> b = SR2::fill(100, 20, 10, 5, -30, -20);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Evaluate the first model to get a_bar</span></div>
<div class="line">  <span class="keyword">auto</span> a_bar_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;a_bar&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> a_bar = eq1-&gt;value({{a_name, a}})[a_bar_name];</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Evaluate the second model to get b_bar</span></div>
<div class="line">  <span class="keyword">auto</span> b_bar_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;b_bar&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> b_bar = eq2-&gt;value({{b_name, <a class="code hl_variable" href="namespaceneml2_1_1crystallography_1_1crystal__symmetry__operators.html#aa93a189fb7bbbf87be54bcc7bd11bb6f">b</a>}})[b_bar_name];</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Evaluate the third model to get b_rate</span></div>
<div class="line">  eq3-&gt;set_parameter(<span class="stringliteral">&quot;c_0&quot;</span>, b_bar);</div>
<div class="line">  eq3-&gt;set_parameter(<span class="stringliteral">&quot;c_1&quot;</span>, a_bar);</div>
<div class="line">  <span class="keyword">auto</span> b_rate_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;b_rate&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> b_rate = eq3-&gt;value({{a_name, <a class="code hl_variable" href="namespaceneml2_1_1crystallography_1_1crystal__symmetry__operators.html#a188caae18b60b66f9f44214c7e28ac1f">a</a>}, {b_name, <a class="code hl_variable" href="namespaceneml2_1_1crystallography_1_1crystal__symmetry__operators.html#aa93a189fb7bbbf87be54bcc7bd11bb6f">b</a>}})[b_rate_name];</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;b_rate: \n&quot;</span> &lt;&lt; b_rate &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1LabeledAxisAccessor_html"><div class="ttname"><a href="classneml2_1_1LabeledAxisAccessor.html">neml2::LabeledAxisAccessor</a></div><div class="ttdoc">The accessor containing all the information needed to access an item in a LabeledAxis.</div><div class="ttdef"><b>Definition</b> LabeledAxisAccessor.h:56</div></div>
<div class="ttc" id="anamespaceneml2_1_1crystallography_1_1crystal__symmetry__operators_html_a188caae18b60b66f9f44214c7e28ac1f"><div class="ttname"><a href="namespaceneml2_1_1crystallography_1_1crystal__symmetry__operators.html#a188caae18b60b66f9f44214c7e28ac1f">neml2::crystallography::crystal_symmetry_operators::a</a></div><div class="ttdeci">constexpr double a</div><div class="ttdef"><b>Definition</b> crystallography.h:36</div></div>
<div class="ttc" id="anamespaceneml2_1_1crystallography_1_1crystal__symmetry__operators_html_aa93a189fb7bbbf87be54bcc7bd11bb6f"><div class="ttname"><a href="namespaceneml2_1_1crystallography_1_1crystal__symmetry__operators.html#aa93a189fb7bbbf87be54bcc7bd11bb6f">neml2::crystallography::crystal_symmetry_operators::b</a></div><div class="ttdeci">constexpr double b</div><div class="ttdef"><b>Definition</b> crystallography.h:37</div></div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> DiagnosticsInterface.cxx:30</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">b_rate: </div>
<div class="line"> 22.6184</div>
<div class="line">  7.7092</div>
<div class="line"> -1.9855</div>
<div class="line">  3.8519</div>
<div class="line">  3.9188</div>
<div class="line">  1.1109</div>
<div class="line">[ CPUDoubleType{6} ]</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> neml2.tensors <span class="keyword">import</span> SR2</div>
<div class="line"><span class="keyword">import</span> torch</div>
<div class="line"> </div>
<div class="line">torch.set_default_dtype(torch.double)</div>
<div class="line">factory = <a class="code hl_function" href="namespaceneml2.html#a95bfc866ea59a23929617ab7ec620a3e">neml2.load_input</a>(<span class="stringliteral">&quot;input.i&quot;</span>)</div>
<div class="line">eq1 = factory.get_model(<span class="stringliteral">&quot;eq1&quot;</span>)</div>
<div class="line">eq2 = factory.get_model(<span class="stringliteral">&quot;eq2&quot;</span>)</div>
<div class="line">eq3 = factory.get_model(<span class="stringliteral">&quot;eq3&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create the input variables</span></div>
<div class="line">a = SR2.fill(0.1, 0.05, -0.03, 0.02, 0.06, 0.03)</div>
<div class="line">b = SR2.fill(100, 20, 10, 5, -30, -20)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Evaluate the first model to get a_bar</span></div>
<div class="line">a_bar = eq1.value({<span class="stringliteral">&quot;forces/a&quot;</span>: a})[<span class="stringliteral">&quot;state/a_bar&quot;</span>]</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Evaluate the second model to get b_bar</span></div>
<div class="line">b_bar = eq2.value({<span class="stringliteral">&quot;state/b&quot;</span>: b})[<span class="stringliteral">&quot;state/b_bar&quot;</span>]</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Evaluate the third model to get b_rate</span></div>
<div class="line">eq3.c_0 = b_bar</div>
<div class="line">eq3.c_1 = a_bar</div>
<div class="line">b_rate = eq3.value({<span class="stringliteral">&quot;forces/a&quot;</span>: a, <span class="stringliteral">&quot;state/b&quot;</span>: b})[<span class="stringliteral">&quot;state/b_rate&quot;</span>]</div>
<div class="line"> </div>
<div class="line">print(<span class="stringliteral">&quot;b_rate:&quot;</span>)</div>
<div class="line">print(b_rate)</div>
<div class="ttc" id="anamespaceneml2_html_a95bfc866ea59a23929617ab7ec620a3e"><div class="ttname"><a href="namespaceneml2.html#a95bfc866ea59a23929617ab7ec620a3e">neml2::load_input</a></div><div class="ttdeci">std::unique_ptr&lt; Factory &gt; load_input(const std::filesystem::path &amp;path, const std::string &amp;additional_input)</div><div class="ttdoc">A convenient function to parse all options from an input file.</div><div class="ttdef"><b>Definition</b> Factory.cxx:34</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">b_rate:</div>
<div class="line"> 22.6184</div>
<div class="line">  7.7092</div>
<div class="line"> -1.9855</div>
<div class="line">  3.8519</div>
<div class="line">  3.9188</div>
<div class="line">  1.1109</div>
<div class="line">[ CPUDoubleType{6} ]</div>
<div class="line">&lt;Tensor of shape [][6]&gt;</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><h1><a class="anchor" id="autotoc_md112"></a>
Evaluating the models: The easy way</h1>
<p>We were able to successfully calculate \( \dot{\boldsymbol{b}} \) by</p><ol type="1">
<li>calculating \( \bar{a} \) by evaluating \( \eqref{1} \),</li>
<li>calculating \( \bar{b} \) by evaluating \( \eqref{2} \),</li>
<li>setting the two coefficients of \( \eqref{3} \) to be \( \bar{b} \) and \( \bar{a} \) respectively,</li>
<li>calculating \( \dot{\boldsymbol{b}} \) by evaluating \( \eqref{3} \).</li>
</ol>
<p>However, that is not ideal because we had to</p><ul>
<li>Manually evaluate the equations and figure out the evaluation order, and</li>
<li>Manually set the parameters in \( \eqref{3} \) as outputs from \( \eqref{1}\&amp;\eqref{2} \).</li>
</ul>
<p>This manual method is not scalable when the number of equations, variables, and parameters increase.</p>
<p>Using NEML2's model composition capability can address these issues without sacrificing modularity. <a class="el" href="syntax-models.html#composedmodel">ComposedModel</a> allows us to compose a new model from the three existing models: </p><div class="fragment"><div class="line">[Models]</div>
<div class="line">  [eq1]</div>
<div class="line">    type = SR2Invariant</div>
<div class="line">    tensor = &#39;forces/a&#39;</div>
<div class="line">    invariant = &#39;state/a_bar&#39;</div>
<div class="line">    invariant_type = I1</div>
<div class="line">  []</div>
<div class="line">  [eq2]</div>
<div class="line">    type = SR2Invariant</div>
<div class="line">    tensor = &#39;state/b&#39;</div>
<div class="line">    invariant = &#39;state/b_bar&#39;</div>
<div class="line">    invariant_type = VONMISES</div>
<div class="line">  []</div>
<div class="line">  [eq3]</div>
<div class="line">    type = SR2LinearCombination</div>
<div class="line">    from_var = &#39;forces/a state/b&#39;</div>
<div class="line">    to_var = &#39;state/b_rate&#39;</div>
<div class="line">    coefficients = &#39;eq2 eq1&#39;</div>
<div class="line">    coefficient_as_parameter = true</div>
<div class="line">  []</div>
<div class="line">  [eq]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = &#39;eq1 eq2 eq3&#39;</div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The names of the other two models are used to specify the coefficients of \( \eqref{3} \), i.e. &lsquo;coefficients = 'eq2 eq1&rsquo;`. This syntax is different from what was covered in the <a class="el" href="tutorials-models-model-parameters.html">previous tutorial</a> on model parameters and will be explained in more details in the <a class="el" href="tutorials-models-model-parameters-revisited.html">next tutorial</a>.</dd></dl>
<p>Let us first inspect the composed model and compare it against the three sub-models:</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> factory = load_input(<span class="stringliteral">&quot;input_composed.i&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eq1 = factory-&gt;get_model(<span class="stringliteral">&quot;eq1&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eq2 = factory-&gt;get_model(<span class="stringliteral">&quot;eq2&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eq3 = factory-&gt;get_model(<span class="stringliteral">&quot;eq3&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eq = factory-&gt;get_model(<span class="stringliteral">&quot;eq&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;eq1:\n&quot;</span> &lt;&lt; *eq1 &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;eq2:\n&quot;</span> &lt;&lt; *eq2 &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;eq3:\n&quot;</span> &lt;&lt; *eq3 &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;eq:\n&quot;</span> &lt;&lt; *eq &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">eq1:</div>
<div class="line">Name:       eq1</div>
<div class="line">Input:      forces/a [SR2]</div>
<div class="line">Output:     state/a_bar [Scalar]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">eq2:</div>
<div class="line">Name:       eq2</div>
<div class="line">Input:      state/b [SR2]</div>
<div class="line">Output:     state/b_bar [Scalar]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">eq3:</div>
<div class="line">Name:       eq3</div>
<div class="line">Input:      forces/a [SR2]</div>
<div class="line">            state/a_bar [Scalar]</div>
<div class="line">            state/b [SR2]</div>
<div class="line">            state/b_bar [Scalar]</div>
<div class="line">Output:     state/b_rate [SR2]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">eq:</div>
<div class="line">Name:       eq</div>
<div class="line">Input:      forces/a [SR2]</div>
<div class="line">            state/b [SR2]</div>
<div class="line">Output:     state/b_rate [SR2]</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> neml2.tensors <span class="keyword">import</span> SR2</div>
<div class="line"> </div>
<div class="line">factory = <a class="code hl_function" href="namespaceneml2.html#a95bfc866ea59a23929617ab7ec620a3e">neml2.load_input</a>(<span class="stringliteral">&quot;input_composed.i&quot;</span>)</div>
<div class="line">eq1 = factory.get_model(<span class="stringliteral">&quot;eq1&quot;</span>)</div>
<div class="line">eq2 = factory.get_model(<span class="stringliteral">&quot;eq2&quot;</span>)</div>
<div class="line">eq3 = factory.get_model(<span class="stringliteral">&quot;eq3&quot;</span>)</div>
<div class="line">eq = factory.get_model(<span class="stringliteral">&quot;eq&quot;</span>)</div>
<div class="line"> </div>
<div class="line">print(<span class="stringliteral">&quot;eq1:&quot;</span>)</div>
<div class="line">print(eq1, <span class="stringliteral">&quot;\n&quot;</span>)</div>
<div class="line">print(<span class="stringliteral">&quot;eq2:&quot;</span>)</div>
<div class="line">print(eq2, <span class="stringliteral">&quot;\n&quot;</span>)</div>
<div class="line">print(<span class="stringliteral">&quot;eq3:&quot;</span>)</div>
<div class="line">print(eq3, <span class="stringliteral">&quot;\n&quot;</span>)</div>
<div class="line">print(<span class="stringliteral">&quot;eq:&quot;</span>)</div>
<div class="line">print(eq, <span class="stringliteral">&quot;\n&quot;</span>)</div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">eq1:</div>
<div class="line">Name:       eq1</div>
<div class="line">Input:      forces/a [SR2]</div>
<div class="line">Output:     state/a_bar [Scalar]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">eq2:</div>
<div class="line">Name:       eq2</div>
<div class="line">Input:      state/b [SR2]</div>
<div class="line">Output:     state/b_bar [Scalar]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">eq3:</div>
<div class="line">Name:       eq3</div>
<div class="line">Input:      forces/a [SR2]</div>
<div class="line">            state/a_bar [Scalar]</div>
<div class="line">            state/b [SR2]</div>
<div class="line">            state/b_bar [Scalar]</div>
<div class="line">Output:     state/b_rate [SR2]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">eq:</div>
<div class="line">Name:       eq</div>
<div class="line">Input:      forces/a [SR2]</div>
<div class="line">            state/b [SR2]</div>
<div class="line">Output:     state/b_rate [SR2]</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><p>Note that the composed model "eq" automatically:</p><ul>
<li>Identified the input variables \( \boldsymbol{a} \) and \( \boldsymbol{b} \),</li>
<li>Identified the output variable \( \dot{\boldsymbol{b}} \),</li>
<li>Registered the parameters of \( \eqref{3} \) as input variables, and</li>
<li>Sorted out the evaluation order.</li>
</ul>
<p>The composed model can be evaluated in the same way as regular models:</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/SR2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line">  set_default_dtype(kFloat64);</div>
<div class="line">  <span class="keyword">auto</span> eq = load_model(<span class="stringliteral">&quot;input_composed.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create the input variables</span></div>
<div class="line">  <span class="keyword">auto</span> a_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> b_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> a = SR2::fill(0.1, 0.05, -0.03, 0.02, 0.06, 0.03);</div>
<div class="line">  <span class="keyword">auto</span> b = SR2::fill(100, 20, 10, 5, -30, -20);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Evaluate the composed model</span></div>
<div class="line">  <span class="keyword">auto</span> b_rate_name = <a class="code hl_class" href="classneml2_1_1LabeledAxisAccessor.html">VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;b_rate&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> b_rate = eq-&gt;value({{a_name, a}, {b_name, b}})[b_rate_name];</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;b_rate: \n&quot;</span> &lt;&lt; b_rate &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">b_rate: </div>
<div class="line"> 22.6184</div>
<div class="line">  7.7092</div>
<div class="line"> -1.9855</div>
<div class="line">  3.8519</div>
<div class="line">  3.9188</div>
<div class="line">  1.1109</div>
<div class="line">[ CPUDoubleType{6} ]</div>
</div><!-- fragment --></li>
<li><p class="startli"><b class="tab-title">Python</b> </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> neml2.tensors <span class="keyword">import</span> SR2</div>
<div class="line"><span class="keyword">import</span> torch</div>
<div class="line"> </div>
<div class="line">torch.set_default_dtype(torch.double)</div>
<div class="line">eq = <a class="code hl_function" href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2.load_model</a>(<span class="stringliteral">&quot;input_composed.i&quot;</span>, <span class="stringliteral">&quot;eq&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create the input variables</span></div>
<div class="line">a = SR2.fill(0.1, 0.05, -0.03, 0.02, 0.06, 0.03)</div>
<div class="line">b = SR2.fill(100, 20, 10, 5, -30, -20)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Evaluate the composed model</span></div>
<div class="line">b_rate = eq.value({<span class="stringliteral">&quot;forces/a&quot;</span>: a, <span class="stringliteral">&quot;state/b&quot;</span>: b})[<span class="stringliteral">&quot;state/b_rate&quot;</span>]</div>
<div class="line"> </div>
<div class="line">print(<span class="stringliteral">&quot;b_rate:&quot;</span>)</div>
<div class="line">print(b_rate)</div>
<div class="ttc" id="anamespaceneml2_html_aa98735f2ffd7c3ae8b0b339621eb8ab3"><div class="ttname"><a href="namespaceneml2.html#aa98735f2ffd7c3ae8b0b339621eb8ab3">neml2::load_model</a></div><div class="ttdeci">std::shared_ptr&lt; Model &gt; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> Model.cxx:43</div></div>
</div><!-- fragment --><p class="startli">Output: </p><div class="fragment"><div class="line">b_rate:</div>
<div class="line"> 22.6184</div>
<div class="line">  7.7092</div>
<div class="line"> -1.9855</div>
<div class="line">  3.8519</div>
<div class="line">  3.9188</div>
<div class="line">  1.1109</div>
<div class="line">[ CPUDoubleType{6} ]</div>
<div class="line">&lt;Tensor of shape [][6]&gt;</div>
</div><!-- fragment --></li>
</ul>
</div><div class="tabbed"></div><div class="section_buttons"></div><div class="section_buttons"><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Previous   </th><th class="markdownTableHeadRight">Next    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="tutorials-models-vectorization.html">Vectorization</a>   </td><td class="markdownTableBodyRight"><a class="el" href="tutorials-models-model-parameters-revisited.html">Model parameters (revisited)</a>   </td></tr>
</table>
</div><div class="section_buttons"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
